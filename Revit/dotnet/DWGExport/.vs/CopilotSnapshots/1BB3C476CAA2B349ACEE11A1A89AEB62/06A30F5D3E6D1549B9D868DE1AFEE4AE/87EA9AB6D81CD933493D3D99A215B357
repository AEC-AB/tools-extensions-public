using DWGExport.Enums;
using System.Text.RegularExpressions;

namespace DWGExport;

public class DWGExportCommand : IRevitExtension<DWGExportArgs>
{
    private DWGExportArgs? _args;
    private int _exportedCount = 0;
    private int _failedCount = 0;
    private readonly List<string> _failureLog = new();

    private void LogFailure(string reason)
    {
        _failedCount += 1;
        var timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
        _failureLog.Add($"[{timestamp}] {reason}");
    }

    private string FormatFailureLog()
    {
        if (_failureLog.Count == 0)
            return string.Empty;

        return "\n\nFailures:\n" + string.Join("\n", _failureLog.Select((x, i) => $"{i + 1}. {x}"));
    }

    public IExtensionResult Run(IRevitExtensionContext context, DWGExportArgs args, CancellationToken cancellationToken)
    {
        _args = args;
        _exportedCount = 0;
        _failedCount = 0;
        _failureLog.Clear();

        var document = context?.UIApplication?.ActiveUIDocument?.Document;
        if (document == null)
            return Result.Text.Failed("No active Revit document.");

        if (!OptionalFunctionalityUtils.IsDWGExportAvailable())
            return Result.Text.Failed("DWG Exporter missing. Please install it and try again!");

        if (string.IsNullOrWhiteSpace(_args.DestinationDirectory))
            return Result.Text.Failed("Destination directory is required.");

        if (cancellationToken.IsCancellationRequested)
            return OperationCancelledResult();

        try
        {
            // Ensure destination directory exists and is writable
            if (!System.IO.Directory.Exists(_args.DestinationDirectory))
            {
                try
                {
                    System.IO.Directory.CreateDirectory(_args.DestinationDirectory!);
                }
                catch (Exception ex)
                {
                    LogFailure($"Failed to access destination directory '{_args.DestinationDirectory}': {ex.Message}");
                    return Result.Text.Failed($"Failed to access destination directory.{FormatFailureLog()}");
                }
            }

            var dwgOptions = CreateDWGOptions();
#if R2022_OR_LESS
            var notLegendFilter = new ElementParameterFilter(ParameterFilterRuleFactory.CreateEqualsRule(new ElementId(BuiltInParameter.VIEW_TYPE_SCHEDULES), "Legend", true), true);
#else
            var notLegendFilter = new ElementParameterFilter(ParameterFilterRuleFactory.CreateEqualsRule(new ElementId(BuiltInParameter.VIEW_TYPE_SCHEDULES), "Legend"), true);
#endif
            using var collector = new FilteredElementCollector(document)
                .WherePasses(notLegendFilter)
                .WhereElementIsNotElementType();

            switch (_args.ExportOption)
            {
                case ExportOptions.ActiveView:
                {
                    var activeView = document.ActiveView;
                    if (activeView == null || !activeView.CanBePrinted)
                        return Result.Text.Failed("Active view cannot be printed.");

                    if (cancellationToken.IsCancellationRequested)
                        return OperationCancelledResult();

                    if (activeView.ViewType == ViewType.DrawingSheet)
                        ExportDrawingSheet(document, dwgOptions, activeView, cancellationToken);
                    else
                        ExportView(document, dwgOptions, activeView, cancellationToken);
                    break;
                }
                case ExportOptions.AllViews:
                {
                    var viewColl = collector.OfClass(typeof(View)).WhereElementIsNotElementType().GetElementIterator();
                    while (viewColl.MoveNext())
                    {
                        if (cancellationToken.IsCancellationRequested)
                            return OperationCancelledResult();

                        var view = viewColl.Current as View;
                        if (view == null)
                        {
                            LogFailure("Skipped view: element is not a View.");
                            continue;
                        }

                        if (!view.CanBePrinted)
                        {
                            LogFailure($"Skipped view '{view.Name}': cannot be printed.");
                            continue;
                        }

                        if (view.ViewType == ViewType.DrawingSheet)
                        {
                            LogFailure($"Skipped view '{view.Name}': is a DrawingSheet (use sheet export). ");
                            continue;
                        }

                        ExportView(document, dwgOptions, view, cancellationToken);
                    }
                    break;
                }
                case ExportOptions.AllSheets:
                {
                    var sheetColl = collector.OfClass(typeof(ViewSheet)).WhereElementIsNotElementType().GetElementIterator();
                    while (sheetColl.MoveNext())
                    {
                        if (cancellationToken.IsCancellationRequested)
                            return OperationCancelledResult();

                        var viewSheet = sheetColl.Current as ViewSheet;
                        if (viewSheet == null)
                        {
                            LogFailure("Skipped sheet: element is not a Sheet.");
                            continue;
                        }

                        if (!viewSheet.CanBePrinted)
                        {
                            LogFailure($"Skipped sheet '{viewSheet.Name}': cannot be printed.");
                            continue;
                        }

                        ExportDrawingSheet(document, dwgOptions, viewSheet, cancellationToken);
                    }
                    break;
                }
                case ExportOptions.CustomFilter:
                {
                    if (_args.CustomFilter == null)
                        return Result.Text.Failed("Custom filter is null.");

                    var views = _args.CustomFilter.WhereElementIsNotElementType().GetElementIterator();
                    while (views.MoveNext())
                    {
                        if (cancellationToken.IsCancellationRequested)
                            return OperationCancelledResult();

                        var view = views.Current as View;
                        if (view == null)
                        {
                            LogFailure("Skipped view: element is not a View.");
                            continue;
                        }

                        if (!view.CanBePrinted)
                        {
                            LogFailure($"Skipped view '{view.Name}': cannot be printed.");
                            continue;
                        }

                        if (view.ViewType == ViewType.DrawingSheet)
                            ExportDrawingSheet(document, dwgOptions, view, cancellationToken);
                        else
                            ExportView(document, dwgOptions, view, cancellationToken);
                    }
                    break;
                }
                case ExportOptions.ViewSet:
                {
                    var viewSet = new FilteredElementCollector(document)
                        .OfClass(typeof(ViewSheetSet))
                        .WhereElementIsNotElementType()
                        .OfType<ViewSheetSet>()
                        .FirstOrDefault(x => x.Name == _args.ViewSet);

                    if (viewSet == null)
                        return Result.Text.Failed("View set not found.");

                    foreach (View view in viewSet.Views)
                    {
                        if (cancellationToken.IsCancellationRequested)
                            return OperationCancelledResult();

                        if (view == null)
                        {
                            LogFailure("Skipped view in view set: view is null.");
                            continue;
                        }

                        if (!view.CanBePrinted)
                        {
                            LogFailure($"Skipped view '{view.Name}' in view set '{viewSet.Name}': cannot be printed.");
                            continue;
                        }

                        if (view.ViewType == ViewType.DrawingSheet)
                            ExportDrawingSheet(document, dwgOptions, view, cancellationToken);
                        else
                            ExportView(document, dwgOptions, view, cancellationToken);
                    }
                    break;
                }
                case ExportOptions.UseRegexInViewSet:
                {
                    var regex = _args.RegexPattern;
                    if (string.IsNullOrWhiteSpace(regex))
                        return Result.Text.Failed("Regex pattern is empty.");

                    if (!IsRegexValid(regex))
                        return Result.Text.Failed("Invalid Regex pattern.");

                    var allViewSets = new FilteredElementCollector(document)
                        .OfClass(typeof(ViewSheetSet))
                        .WhereElementIsNotElementType()
                        .GetElementIterator();

                    while (allViewSets.MoveNext())
                    {
                        if (cancellationToken.IsCancellationRequested)
                            return OperationCancelledResult();

                        if (allViewSets.Current is not ViewSheetSet viewSetRegex)
                        {
                            LogFailure("Skipped view set: element is not a View Set.");
                            continue;
                        }

                        if (!Regex.IsMatch(viewSetRegex.Name, regex))
                            continue;

                        foreach (View view in viewSetRegex.Views)
                        {
                            if (cancellationToken.IsCancellationRequested)
                                return OperationCancelledResult();

                            if (view == null)
                            {
                                LogFailure($"Skipped view in view set '{viewSetRegex.Name}': view is null.");
                                continue;
                            }

                            if (!view.CanBePrinted)
                            {
                                LogFailure($"Skipped view '{view.Name}' in view set '{viewSetRegex.Name}': cannot be printed.");
                                continue;
                            }

                            if (view.ViewType == ViewType.DrawingSheet)
                                ExportDrawingSheet(document, dwgOptions, view, cancellationToken);
                            else
                                ExportView(document, dwgOptions, view, cancellationToken);
                        }
                    }

                    if (cancellationToken.IsCancellationRequested)
                        return OperationCancelledResult();

                    if (_exportedCount == 0)
                        return Result.Text.Failed($"No view set matches the regex pattern.{FormatFailureLog()}");

                    break;
                }
                default:
                    throw new ArgumentOutOfRangeException(nameof(_args.ExportOption), _args.ExportOption, "Unsupported export option.");
            }

            if (_exportedCount == 0)
                return Result.Text.Failed($"No views or sheets were exported.{FormatFailureLog()}");

            if (_failedCount > 0)
                return Result.Text.PartiallySucceeded($"Export completed with failures. Exported: {_exportedCount}, Failed: {_failedCount}{FormatFailureLog()}");

            return Result.Text.Succeeded($"Export completed. Exported: {_exportedCount}, Failed: {_failedCount}");
        }
        catch (OperationCanceledException)
        {
            return OperationCancelledResult();
        }
        catch (Exception exception)
        {
            LogFailure($"Unhandled error during DWG export: {exception.Message}");
            return Result.Text.Failed($"Unhandled error during DWG export: {exception.Message}{FormatFailureLog()}");
        }
    }

    private IExtensionResult OperationCancelledResult()
    {
        return Result.Text.Failed($"Operation cancelled. Exported: {_exportedCount}, Failed: {_failedCount}{FormatFailureLog()}");
    }

    private static bool IsRegexValid(string pattern)
    {
        if (string.IsNullOrWhiteSpace(pattern))
            return false;

        try
        {
            _ = Regex.Match(string.Empty, pattern);
            return true;
        }
        catch (ArgumentException)
        {
            return false;
        }
    }

    private void ExportView(Document doc, DWGExportOptions dwgOptions, View view, CancellationToken cancellationToken)
    {
        cancellationToken.ThrowIfCancellationRequested();

        var viewName = GetDwgName(view);

        try
        {
            var expViews = new List<ElementId> { view.Id };

            // Prefer an overload that accepts CancellationToken if available in the referenced Revit version.
            // Fallback to the classic overload otherwise.
            var success = ExportWithCancellationFallback(doc, _args!.DestinationDirectory, viewName, expViews, dwgOptions, cancellationToken);

            if (success)
            {
                _exportedCount++;
            }
            else
            {
                LogFailure($"Export failed for view '{view.Name}'");
            }
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (Exception ex)
        {
            LogFailure($"Exception exporting view '{view.Name}' (DWG name: '{viewName}'): {ex.Message}");
            throw;
        }
    }

    private void ExportDrawingSheet(Document doc, DWGExportOptions dwgOptions, View view, CancellationToken cancellationToken)
    {
        cancellationToken.ThrowIfCancellationRequested();

        var viewName = GetDwgName(view);

        try
        {
            var expViews = new List<ElementId> { view.Id };

            var success = ExportWithCancellationFallback(doc, _args!.DestinationDirectory, viewName, expViews, dwgOptions, cancellationToken);

            if (success)
            {
                _exportedCount++;
            }
            else
            {
                LogFailure($"Export failed for sheet '{view.Name}'");
            }
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (Exception ex)
        {
            LogFailure($"Exception exporting sheet '{view.Name}' (DWG name: '{viewName}'): {ex.Message}");
            throw;
        }
    }

    private static bool ExportWithCancellationFallback(
        Document doc,
        string? destinationDirectory,
        string fileName,
        ICollection<ElementId> views,
        DWGExportOptions dwgOptions,
        CancellationToken cancellationToken)
    {
        cancellationToken.ThrowIfCancellationRequested();

        // If the Revit API exposes a CancellationToken overload in the referenced assemblies,
        // this dynamic call will bind to it; otherwise it will fall back to the standard overload.
        try
        {
            dynamic d = doc;
            dynamic o = dwgOptions;
            return (bool)d.Export(destinationDirectory, fileName, views, o, cancellationToken);
        }
        catch (Microsoft.CSharp.RuntimeBinder.RuntimeBinderException)
        {
            cancellationToken.ThrowIfCancellationRequested();
            return doc.Export(destinationDirectory, fileName, views, dwgOptions);
        }
    }
}