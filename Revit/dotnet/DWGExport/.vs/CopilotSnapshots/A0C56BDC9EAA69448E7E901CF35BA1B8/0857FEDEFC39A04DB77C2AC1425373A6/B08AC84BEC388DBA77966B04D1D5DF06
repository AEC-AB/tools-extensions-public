using System.Text.RegularExpressions;

namespace DWGExport
{
    public class DWGExportCommand : IRevitExtension<DWGExportArgs>
    {
        private DWGExportArgs? _args;
        private int _exportedCount = 0;
        private int _failedCount = 0;
        public IExtensionResult Run(IRevitExtensionContext context, DWGExportArgs args, CancellationToken cancellationToken)
        {
            _args = args;

            var document = context.UIApplication.ActiveUIDocument?.Document;

            if (document == null)
                return Result.Text.Failed("No active Revit document.");

            if (!OptionalFunctionalityUtils.IsDWGExportAvailable())
                return Result.Text.Failed($"DWG Exporter missing. Please install it and try again!");

            if (string.IsNullOrWhiteSpace(args.DestinationDirectory))
                return Result.Text.Failed($"Destination directory is required.");
         
            try
            {
                if (cancellationToken.IsCancellationRequested)
                    return Result.Text.Failed($"Operation cancelled. Exported: {_exportedCount}, Failed: {_failedCount}");

                // Ensure destination directory exists
                if (!System.IO.Directory.Exists(_args.DestinationDirectory))
                {
                    try
                    {
                        System.IO.Directory.CreateDirectory(_args.DestinationDirectory!);
                    }
                    catch (Exception ex)
                    {
                        return Result.Text.Failed($"Failed to access destination directory: {ex.Message}.");
                    }
                }

                var DWGOptions = CreateDWGOptions();
#if R2022_OR_LESS
                var notLegendFilter = new ElementParameterFilter(ParameterFilterRuleFactory.CreateEqualsRule(new ElementId(BuiltInParameter.VIEW_TYPE_SCHEDULES), "Legend", true), true);
#else
                var notLegendFilter = new ElementParameterFilter(ParameterFilterRuleFactory.CreateEqualsRule(new ElementId(BuiltInParameter.VIEW_TYPE_SCHEDULES), "Legend"), true);
#endif
                using var collector = new FilteredElementCollector(document).WherePasses(notLegendFilter).WhereElementIsNotElementType();

                switch (_args.ExportOption)
                {
                    case ExportOptions.ActiveView:
                        var activeView = document.ActiveView;
                        if (activeView.CanBePrinted && activeView.ViewType == ViewType.DrawingSheet)
                            ExportDrawingSheet(document, DWGOptions, activeView);
                        else if (activeView.CanBePrinted && activeView.ViewType != ViewType.DrawingSheet)
                            ExportView(document, DWGOptions, activeView);
                        break;
                    case ExportOptions.AllViews:
                        var viewColl = collector.OfClass(typeof(View)).GetElementIterator();
                        while (viewColl.MoveNext())
                        {
                            using var view = viewColl.Current as View;
                            if (view == null || !view.CanBePrinted)
                                continue;
                            if (view.CanBePrinted && view.ViewType != ViewType.DrawingSheet)
                                ExportView(document, DWGOptions, view);
                        }
                        break;
                    case ExportOptions.AllSheets:
                        var sheetColl = collector.OfClass(typeof(ViewSheet)).GetElementIterator();
                        while (sheetColl.MoveNext())
                        {
                            using var view = sheetColl.Current as ViewSheet;
                            if (view == null || !view.CanBePrinted)
                                continue;

                            var sheetNumber = view.LookupParameter("Sheet Number").AsString();
                            ExportDrawingSheet(document, DWGOptions, view);                   
                        }
                        break;

                        case ExportOptions.CustomFilter:
                            if (_args.CustomFilter == null)
                                return Result.Text.Failed("Custom filter is null.");
                            var views = _args.CustomFilter.GetElementIterator();
                            while (views.MoveNext())
                            {
                                using var view = views.Current as View;
                                if (view == null || !view.CanBePrinted)
                                    continue;
                                if (view.ViewType == ViewType.DrawingSheet)
                                    ExportDrawingSheet(document, DWGOptions, view);
                                else
                                    ExportView(document, DWGOptions, view);
                             }
                            break;
                
                    case ExportOptions.ViewSet:
                        var viewSet = new FilteredElementCollector(document).OfClass(typeof(ViewSheetSet))
                            .OfType<ViewSheetSet>().
                            FirstOrDefault(x => x.Name == _args.ViewSet);
                        if (viewSet == null)
                            return Result.Text.Failed("View set not found.");

                        foreach (View view in viewSet.Views)
                        {
                            if(view == null || !view.CanBePrinted)
                                continue;
                            if (view.ViewType == ViewType.DrawingSheet)
                                ExportDrawingSheet(document, DWGOptions, view);
                            else 
                                ExportView(document, DWGOptions, view);
                        }      
                        break;
                    case ExportOptions.UseRegexInViewSet:
                        var regex = _args.RegexPattern;
                        if (string.IsNullOrEmpty(regex))
                            return Result.Text.Failed("Regex pattern is empty");

                        if (!IsRegexValid(regex))
                            return Result.Text.Failed("Invalid Regex pattern");

                        var allViewSets = new FilteredElementCollector(document).OfClass(typeof(ViewSheetSet)).GetElementIterator();
                        while (allViewSets.MoveNext())
                        {
                            var viewSetRegex = allViewSets.Current as ViewSheetSet;
                            if (viewSetRegex == null) continue;
                            if (!Regex.IsMatch(viewSetRegex.Name, regex))
                                continue;

                            foreach (View view in viewSetRegex.Views)
                            {
                                if (view == null || !view.CanBePrinted)
                                    continue;
                                if (view.ViewType == ViewType.DrawingSheet)
                                    ExportDrawingSheet(document, DWGOptions, view);
                                else 
                                    ExportView(document, DWGOptions, view);
                                _exportedCount++;
                            }
                        }
                        if (_exportedCount == 0)
                            return Result.Text.Failed("No view set that match the regex pattern");
                        break;
                    default:
                        throw new ArgumentOutOfRangeException();
                }
                return Result.Empty.Succeeded();
            }
            catch (Exception exception)
            {
                return Result.Text.Failed(exception.Message + "\n" + exception.StackTrace);
            }
        }

        private bool IsRegexValid(string pattern)
        {
            if (string.IsNullOrEmpty(pattern))
                return false;

            try
            {
                Regex.Match("", pattern); 
                return true; 
            }
            catch (ArgumentException) 
            {
                return false; 
            }
        }

        private void ExportView(Document doc, DWGExportOptions DWGOptions, View view)
        {
            var expViews = new List<ElementId>() { view.Id };
            var viewName = GetDwgName(view);
            doc.Export(_args.DestinationDirectory, viewName, expViews, DWGOptions);
        }

        private void ExportDrawingSheet(Document doc, DWGExportOptions DWGOptions, View view)
        {
            var expViews = new List<ElementId>() { view.Id };
            var viewName = GetDwgName(view);
            doc.Export(_args.DestinationDirectory, viewName, expViews, DWGOptions);
        }

        private DWGExportOptions CreateDWGOptions()
        {
            return new DWGExportOptions
            {
                ACAPreference = _args.ACAPreference,
                Colors = _args.Colors,
                ExportingAreas = _args.ExportingAreas,
                ExportOfSolids = _args.ExportOfSolids,
                FileVersion = _args.FileVersion,
                //HatchBackgroundColor = _args.HatchBackgroundColor,
                //HatchPatternsFileName = _args.HatchPatternsFileName,
                HideReferencePlane = _args.HideReferencePlane,
                HideScopeBox = _args.HideScopeBox,
                HideUnreferenceViewTags = _args.HideUnreferenceViewTags,
                //LayerMapping = _args.LayerMapping,
                //LineScaling = _args.LineScaling,
                //LinetypesFileName = _args.LinetypesFileName,
                MarkNonplotLayers = false,
                MergedViews = _args.MergedViews,
                //NonplotSuffix = _args.NonplotSuffix,
                PreserveCoincidentLines = _args.PreserveCoincidentLines,
                PropOverrides = _args.PropOverrideMode,
                SharedCoords = _args.SharedCoords,
                TargetUnit = _args.values,
                //TextTreatment = _args.TextTreatment,
                //UseHatchBackgroundColor = _args.UseHatchBackgroundColor


            };
        }

        private string GetDwgName(View view)
        {
            string fileName;
            var fullPath = FullPath(view.Document);
            var docName = System.IO.Path.GetFileNameWithoutExtension(fullPath);
            var separator = _args.SeparatorInFileName;
            switch (_args.NamingOptions)
            {
                case NamingOptions.ViewNameOnly:
                    fileName = view.Name;
                    break;
                case NamingOptions.ModelNameOnly:
                    fileName = docName;
                    break;
                case NamingOptions.ModelNameAndViewName:
                    fileName = $"{docName}{separator}{view.Name}";
                    break;
                case NamingOptions.ViewNameAndModelName:
                    fileName = $"{view.Name}{separator}{docName}";
                    break;
                case NamingOptions.Custom:
                    var customFileName = _args.CustomNamingConvention;
                    if (string.IsNullOrEmpty(customFileName))
                    {
                        fileName = view.Name;
                        break;
                    }
                    customFileName = customFileName!.Replace("{ViewName}", view.Name);
                    customFileName = customFileName.Replace("{ModelName}", docName);
                    if (customFileName.Contains("{"))
                        customFileName = ReplaceRevitParameterVariables(customFileName, view);

                    fileName = customFileName;
                    break;
                default:
                    fileName = view.Name;
                    break;
            }

            if (!string.IsNullOrEmpty(_args.PrefixFileName))
                fileName = _args.PrefixFileName + fileName;

            if (!string.IsNullOrEmpty(_args.SuffixFileName))
                fileName += _args.SuffixFileName;

            fileName = Regex.Replace(fileName, @"[<>:""/\\|?*]", "_");

            return fileName;
        }

        private static string ReplaceRevitParameterVariables(string customFileName, View view)
        {
            var parameters = view.Parameters;
            foreach (Parameter param in parameters)
            {
                var paramValue = param.AsValueString();
                if (string.IsNullOrEmpty(paramValue))
                    continue;
                var paramName = param.Definition.Name;
                customFileName = customFileName.Replace("{" + paramName + "}", paramValue);
            }
            return customFileName;
        }

        public static string FullPath(Document document)
        {
            if (document.IsLinked || !document.IsWorkshared)
                return document.PathName;
            var modelPath = document.GetWorksharingCentralModelPath();
            var path = ModelPathUtils.ConvertModelPathToUserVisiblePath(modelPath);
            return string.IsNullOrEmpty(path) ? document.PathName : path;
        }    
    }
}