using CW.Assistant.Extensions.Contracts.Fields;
using CW.Assistant.Extensions.Contracts.Fields.Revit;
using PrintPDF.Enums;

namespace PrintPDF
{
    public class PrintPDFArgs
    {
        [FolderPickerField(
            Label = "Destination Directory",
            ToolTip = "Choose where exported PDFs are saved")]
        public string? DestinationDirectory { get; set; }

        [OptionsField(
            Label = "Export Option",
            ToolTip = "Select which sheets/views to export")]
        public ExportOptions ExportOption { get; set; } = ExportOptions.ViewSet;

        [FilterField(
            Label = "Custom Filter",
            ToolTip = "Define rules to pick sheets when Custom Filter is selected",
            UseActiveDocument = true,
            Categories = ["Sheets"],
            DisableCategorySelection = true,
            DisableModelSelection = true,
            Visibility = $"{nameof(ExportOption)} == 'CustomFilter'")]
        public FilteredElementCollector? CustomFilter { get; set; }

        [OptionsField(
            Label = "Sheet Set",
            ToolTip = "Select a saved sheet set",
            CollectorType = typeof(ViewSetCollector),
            Visibility = $"{nameof(ExportOption)} == 'ViewSet'")]
        public string? ViewSet { get; set; }

        [OptionsField(
            Label = "View collection",
            ToolTip = "Select a saved view collection",
            CollectorType = typeof(ViewCollectionCollector),
            Visibility = $"{nameof(ExportOption)} == 'ViewCollection'")]
        public string? ViewCollection { get; set; }

        [TextField(
            Label = "Regex Pattern",
            ToolTip = "Regex used to match views/sheets by name",
            Visibility = $"{nameof(ExportOption)} == 'UseRegexInViewSet' || {nameof(ExportOption)} == 'UseRegexInViewCollections'")]
        public string? RegexPattern { get; set; }

        [OptionsField(
            Label = "Naming Options",
            ToolTip = "Choose how the PDF file name is built",
            CollectorSortOrder = SortOrder.None)]
        public NamingOptions NamingOptions { get; set; } = NamingOptions.SheetNameOnly;

        [TextField(
            Label = "Separator in File Name",
            ToolTip = "Separator used between file name parts")]
        public string SeparatorInFileName { get; set; } = "-";

        [TextField(
            Label = "Prefix in file name (Optional)",
            ToolTip = "Text added before the file name")]
        public string? PrefixFileName { get; internal set; }

        [TextField(
            Label = "Suffix in file name (Optional)",
            ToolTip = "Text added after the file name")]
        public string? SuffixFileName { get; internal set; }

        [TextField(
            Label = "Custom Naming Convention",
            ToolTip = "Custom pattern using tokens like {SheetName} or {ModelName}",
            Visibility = $"{nameof(NamingOptions)} == 'Custom'")]
        public string? CustomNamingConvention { get; set; }

        [BooleanField(
            Label ="Combine",
            ToolTip = "Export to a single PDF instead of one per sheet/view")]
        public bool Combine { get; set; }

        [BooleanField(
            Label = "Use sheet set name as PDF Name",
            ToolTip ="Use the selected sheet set name for the combined PDF",
             Visibility = nameof(Combine))]
        public bool UseSheetSetNameAsPdfName { get; set; }

        [TextField(
            Label = "Combined File Name (Optional)",
            ToolTip = "File name to use for the combined PDF",
            Visibility = $"{nameof(Combine)} && {nameof(UseSheetSetNameAsPdfName)} == 'false'")]
        public string? CombinedFileName { get; set; }

        [BooleanField(
            Label = "Always Use Raster",
            ToolTip = "Force raster processing for all content")]
        public bool AlwaysUseRaster { get; set; } = false;

        [OptionsField(
            Label = "Color Depth Type",
            ToolTip = "Choose black/white, grayscale, or color")]
        public ColorDepthType ColorDepthType { get; set; } = ColorDepthType.Color;

        [OptionsField(
            Label = "PDF Export Quality Type",
            ToolTip = "Select the PDF export DPI")]
        public PDFExportQualityType PDFExportQualityType { get; set; } = PDFExportQualityType.DPI144;

        [BooleanField(
            Label = "Hide Crop Boundaries",
            ToolTip = "Hide crop boundaries in the exported PDF")]
        public bool HideCropBoundaries { get; set; } = true;

        [BooleanField(
            Label = "Hide Reference Plane",
            ToolTip = "Hide reference planes in the exported PDF")]
        public bool HideReferencePlane { get; set; } = true;

        [BooleanField(
            Label = "Hide Scope Boxes",
            ToolTip = "Hide scope boxes in the exported PDF")]
        public bool HideScopeBoxes { get; set; } = true;

        [BooleanField(
            Label = "Hide Unreferenced View Tags",
            ToolTip = "Hide unreferenced view tags in the exported PDF")]
        public bool HideUnreferencedViewTags { get; set; } = true;

        [BooleanField(
            Label = "Mask Coincident Lines",
            ToolTip = "Mask overlapping lines for clearer output")]
        public bool MaskCoincidentLines { get; set; } = true;

        [BooleanField(
            Label = "Replace Halftone With Thin Lines",
            ToolTip = "Replace halftone lines with thin lines")]
        public bool ReplaceHalftoneWithThinLines { get; set; } = true;

        [BooleanField(
            Label = "View Links In Blue",
            ToolTip = "Render links in blue in the exported PDF")]
        public bool ViewLinksInBlue { get; set; }

        [DoubleField(
            Label = "Origin Offset X",
            ToolTip = "Horizontal offset from the paper origin")]
        public double OriginOffsetX { get; set; }

        [DoubleField(
            Label = "Origin Offset Y",
            ToolTip = "Vertical offset from the paper origin")]
        public double OriginOffsetY { get; set; }

        [IntegerField(
            Label = "Zoom Percentage",
            ToolTip = "Zoom level used when Zoom Type is set to Zoom")]
        public int ZoomPercentage { get; set; }

        [OptionsField(
            Label = "Paper Format",
            ToolTip = "Select the paper size for export")]
        public ExportPaperFormat ExportPaperFormat { get; set; } = ExportPaperFormat.Default;

        [OptionsField(
            Label = "Page Orientation Type",
            ToolTip = "Select portrait, landscape, or auto")]
        public PageOrientationType PageOrientationType { get; set; } = PageOrientationType.Landscape;

        [OptionsField(
            Label = "Paper Placement Type",
            ToolTip = "Choose centering or offset placement")]
        public PaperPlacementType PaperPlacementType { get; set; } = PaperPlacementType.Center;

        [OptionsField(
            Label = "Raster Quality Type",
            ToolTip = "Select raster output DPI")]
        public RasterQualityType RasterQualityType { get; set; } = RasterQualityType.High;

        [OptionsField(
            Label = "Zoom Type",
            ToolTip = "Choose fit to page or a fixed zoom")]
        public ZoomType ZoomType { get; set; } = ZoomType.FitToPage;

        [BooleanField(
            Label = "Open View On Export",
            ToolTip = "Open each view before exporting")]
        public bool OpenViewOnExport { get; set; }
    }

    internal class ViewCollectionCollector : IRevitAutoFillCollector<PrintPDFArgs>
    {
        public Dictionary<string, string> Get(UIApplication uiApplication, PrintPDFArgs args)
        {
            var result = new Dictionary<string, string>();

            try
            {
                var document = uiApplication.ActiveUIDocument?.Document;

                if (document is null)
                    return result;

                var viewCollections = new FilteredElementCollector(document).OfCategory(BuiltInCategory.OST_SheetCollections)
                                .WhereElementIsNotElementType().ToElements();

                foreach (var viewCollection in viewCollections)
                {
                    result.Add(viewCollection.Name, viewCollection.Name);
                }
            }
            catch
            {
                // ignore
            }

            return result;
        }
    }
    internal class ViewSetCollector : IRevitAutoFillCollector<PrintPDFArgs>
    {
        public Dictionary<string, string> Get(UIApplication uiApplication, PrintPDFArgs args)
        {
            var result = new Dictionary<string, string>();

            try
            {
                var document = uiApplication.ActiveUIDocument?.Document;

                if (document is null)
                    return result;

                var viewSets = new FilteredElementCollector(document).OfClass(typeof(ViewSheetSet)).ToElements();

                foreach (var viewSet in viewSets)
                {
                    result.Add(viewSet.Name, viewSet.Name);
                }
            }
            catch
            {
                // ignore
            }

            return result;
        }
    }
}